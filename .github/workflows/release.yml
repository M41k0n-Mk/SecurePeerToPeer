name: Release Build & Sign

on:
  release:
    types: [created]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build (with tests)
        run: mvn -B -e clean verify

      - name: Package (skip tests)
        run: mvn -B -DskipTests package

      - name: Generate SHA256 checksums
        run: |
          cd target
          for f in *.jar; do
            sha256sum "$f" > "$f.sha256"
          done

      # Detecta se as secrets de GPG estão presentes de forma compatível com a expressão language
      - name: Check GPG secrets presence (optional)
        id: gpgcheck
        shell: bash
        run: |
          if [[ -n "${{ secrets.GPG_PRIVATE_KEY }}" && -n "${{ secrets.GPG_PASSPHRASE }}" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import GPG key (optional)
        id: import_gpg
        if: ${{ steps.gpgcheck.outputs.enabled == 'true' }}
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Sign artifacts with GPG (optional)
        if: ${{ steps.import_gpg.outputs.fingerprints != '' }}
        run: |
          cd target
          for f in *.jar *.sha256; do
            gpg --batch --yes --armor --detach-sign --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" "$f"
          done
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/*.jar
            target/*.jar.sha256
            target/*.asc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
